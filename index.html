<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survivalist Manager - Dracula Edition</title>

    <!-- 
      MODO OFFLINE:
      Para funcionamento sem internet, baixe estes arquivos e mude o src:
      1. react.production.min.js
      2. react-dom.production.min.js
      3. babel.min.js
      4. tailwind.js
    -->
    <script src="./react.production.min.js" ></script>
    <script src="./react-dom.production.min.js" ></script>
    <script src="./babel.min.js" ></script>
    <script src="./tailwind.js" ></script>

    <!-- Configuração do Tema Dracula no Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dracula: {
                            bg: '#282a36',
                            current: '#44475a',
                            fg: '#f8f8f2',
                            comment: '#6272a4',
                            cyan: '#8be9fd',
                            green: '#50fa7b',
                            orange: '#ffb86c',
                            pink: '#ff79c6',
                            purple: '#bd93f9',
                            red: '#ff5555',
                            yellow: '#f1fa8c'
                        }
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    },
                    animation: {
                        'bounce-in': 'bounceIn 0.5s cubic-bezier(0.8, 0, 1, 1)',
                    },
                    keyframes: {
                        bounceIn: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.05)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #282a36;
            color: #f8f8f2;
        }
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #282a36; 
        }
        ::-webkit-scrollbar-thumb {
            background: #44475a; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6272a4; 
        }
        
        /* Input Date Customization for Dark Mode */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        /* ANIMAÇÕES PERSONALIZADAS */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stagger-item {
            opacity: 0; /* Começa invisível */
            animation: fadeInUp 0.4s ease-out forwards;
        }

        /* Efeito de brilho nas barras do gráfico */
        .chart-bar-group:hover rect {
            filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.6));
            opacity: 1;
        }
        .chart-bar-group rect {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. DADOS E LISTAS ---

        // Lista de sugestões para autocompletar
        const PREDEFINED_LIST = [
            // Alimentos
            "Arroz Branco", "Feijão Preto", "Feijão Carioca", "Macarrão", "Sal", "Açúcar", "Mel", 
            "Leite em Pó", "Café Solúvel", "Óleo de Soja", "Azeite", "Vinagre", 
            "Carne Enlatada (SPAM)", "Atum em Conserva", "Sardinha", "Milho em Conserva", "Ervilha",
            "Farinha de Trigo", "Fubá", "Aveia", "Barras de Proteína", "Chocolate Amargo",
            // Água
            "Água Potável 5L", "Pastilhas de Cloro", "Filtro Portátil",
            // Saúde
            "Paracetamol", "Ibuprofeno", "Dipirona", "Antibióticos", "Antialérgico", 
            "Gaze Estéril", "Esparadrapo", "Álcool 70%", "Água Oxigenada", "Curativos (Band-aid)", 
            "Luvas de Procedimento", "Soro Fisiológico",
            // Higiene
            "Papel Higiênico", "Sabonete", "Pasta de Dente", "Shampoo", "Sabão em Barra", 
            "Água Sanitária", "Sacos de Lixo 100L",
            // Energia & Ferramentas
            "Pilhas AA", "Pilhas AAA", "Baterias CR2032", "Velas", "Isqueiros", "Fósforos", 
            "Gás de Cozinha P13", "Cartucho de Gás (Camping)", "Querosene",
            // Defesa
            "Munição Cal. 12", "Munição .380", "Munição 9mm", "Spray de Pimenta", "Faca de Combate"
        ];

        // Helper para datas
        const getTodayDate = () => new Date().toISOString().split('T')[0];
        const getFutureDate = (years = 1) => {
            const d = new Date();
            d.setFullYear(d.getFullYear() + years);
            return d.toISOString().split('T')[0];
        };

        const DEFAULT_ITEMS = [
            { id: 1, name: 'Água Potável', category: 'Agua', qty: 50, target: 180, unit: 'Litros', icon: 'droplet', dateAdded: '2023-10-01', expiryDate: '2024-10-01' },
            { id: 2, name: 'Pastilhas de Cloro', category: 'Agua', qty: 2, target: 10, unit: 'Potes', icon: 'droplet', dateAdded: '2023-10-01', expiryDate: '2028-10-01' },
            { id: 3, name: 'Arroz (Vácuo)', category: 'Alimento', qty: 10, target: 45, unit: 'kg', icon: 'utensils', dateAdded: '2023-11-15', expiryDate: '2025-11-15' },
            { id: 4, name: 'Leite em Pó', category: 'Alimento', qty: 5, target: 15, unit: 'Latas', icon: 'utensils', dateAdded: '2023-09-01', expiryDate: '2023-12-25' }, // Exemplo vencendo
            { id: 5, name: 'Enlatados (Proteína)', category: 'Alimento', qty: 12, target: 90, unit: 'Latas', icon: 'utensils', dateAdded: '2023-10-01', expiryDate: '2026-10-01' },
            { id: 6, name: 'Kit Primeiros Socorros', category: 'Saude', qty: 1, target: 2, unit: 'Kit', icon: 'heart-pulse', dateAdded: '2023-01-01', expiryDate: '2026-01-01' },
            { id: 7, name: 'Munição Cal. 12', category: 'Defesa', qty: 25, target: 100, unit: 'Unid', icon: 'shield', dateAdded: '2023-05-20', expiryDate: '2033-05-20' },
            { id: 8, name: 'Pilhas AA', category: 'Energia', qty: 8, target: 48, unit: 'Unid', icon: 'zap', dateAdded: '2023-12-01', expiryDate: '2030-12-01' },
        ];

        // --- 2. ÍCONES SVG ---
        const Icons = {
            droplet: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>,
            utensils: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>,
            'heart-pulse': <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.42 4.58a5.4 5.4 0 0 0-7.65 0l-.77.78-.77-.78a5.4 5.4 0 0 0-7.65 0C1.46 5.68 1.33 10.27 4 13.05L12 21l8-7.95c2.67-2.78 2.54-7.37.42-8.47z"/><path d="M12 11v6"/></svg>,
            shield: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            zap: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            plus: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            minus: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            trash: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            edit: <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            download: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
            upload: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
            fileText: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
            clock: <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
            grid: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
            list: <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
        };

        const { useState, useEffect, useMemo, useRef } = React;

        // --- 3. COMPONENTES UI ---

        const Button = ({ children, onClick, variant = 'primary', className = '', title = '' }) => {
            const variants = {
                primary: 'bg-dracula-purple text-dracula-bg hover:bg-dracula-pink active:scale-95',
                secondary: 'bg-dracula-current text-dracula-fg hover:bg-dracula-comment active:scale-95',
                danger: 'bg-dracula-red text-dracula-bg hover:opacity-80 active:scale-95',
                success: 'bg-dracula-green text-dracula-bg hover:opacity-80 active:scale-95',
                outline: 'border border-dracula-purple text-dracula-purple hover:bg-dracula-purple hover:text-dracula-bg active:scale-95'
            };
            return (
                <button 
                    onClick={onClick} 
                    title={title}
                    className={`px-3 py-2 rounded font-bold transition-all duration-200 shadow-md flex items-center justify-center gap-2 ${variants[variant]} ${className}`}
                >
                    {children}
                </button>
            );
        };

        const ProgressBar = ({ current, target }) => {
            const percent = Math.min(100, Math.max(0, Math.round((current / target) * 100)));
            let colorClass = 'bg-dracula-green';
            if (percent < 30) colorClass = 'bg-dracula-red';
            else if (percent < 70) colorClass = 'bg-dracula-orange';

            return (
                <div className="w-full bg-dracula-bg rounded-full h-3 border border-dracula-comment mt-2 relative overflow-hidden">
                    <div className={`h-full ${colorClass} transition-all duration-500`} style={{ width: `${percent}%` }}></div>
                </div>
            );
        };

        // Modal de Confirmação de Exclusão
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[60] p-4 backdrop-blur-sm">
                    <div className="bg-dracula-current p-6 rounded-lg w-full max-w-sm shadow-2xl border border-dracula-red animate-[bounceIn_0.3s_ease-out]">
                        <div className="flex items-center gap-3 mb-4 text-dracula-red">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                            <h3 className="text-xl font-bold">{title}</h3>
                        </div>
                        <p className="text-dracula-fg mb-6 opacity-90">{message}</p>
                        <div className="flex justify-end gap-3">
                            <Button onClick={onClose} variant="secondary">Cancelar</Button>
                            <Button onClick={onConfirm} variant="danger">Confirmar Exclusão</Button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE: GRÁFICO DE RISCO (COM EFEITOS LEGAIS) ---
        const RiskChart = ({ items, onCategoryClick, onFilterRisk, activeFilter }) => {
            const categoryData = useMemo(() => {
                const categories = {};
                const today = new Date();

                items.forEach(item => {
                    if (!categories[item.category]) {
                        categories[item.category] = { 
                            name: item.category, 
                            total: 0, 
                            critical: 0, // <= 5 dias
                            warning: 0,  // <= 15 dias
                            attention: 0, // <= 30 dias
                            safe: 0 
                        };
                    }
                    
                    categories[item.category].total += 1;

                    let daysLeft = 9999;
                    if (item.expiryDate) {
                        const expiry = new Date(item.expiryDate);
                        const diffTime = expiry - today;
                        daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    }

                    if (daysLeft <= 5) categories[item.category].critical += 1;
                    else if (daysLeft <= 15) categories[item.category].warning += 1;
                    else if (daysLeft <= 30) categories[item.category].attention += 1;
                    else categories[item.category].safe += 1;
                });

                // Ordenar por categorias mais críticas primeiro
                return Object.values(categories).sort((a, b) => {
                    const scoreA = (a.critical * 10) + (a.warning * 5) + (a.attention * 1);
                    const scoreB = (b.critical * 10) + (b.warning * 5) + (b.attention * 1);
                    return scoreB - scoreA || b.total - a.total;
                });
            }, [items]);

            const height = 220;
            const barWidth = 40;
            const gap = 30;
            const padding = 40;
            const width = Math.max(600, (categoryData.length * (barWidth + gap)) + (padding * 2));
            
            const maxCount = Math.max(...categoryData.map(d => d.total), 1) + 1;
            const barHeight = (val) => (val / maxCount) * (height - (padding * 2));

            // Helper para estilos dos botões de filtro da legenda
            const legendBtnClass = (filterKey, colorClass) => `
                flex items-center gap-1 px-2 py-1 rounded cursor-pointer transition-all border 
                ${activeFilter === filterKey 
                    ? `bg-dracula-current border-${colorClass} shadow-[0_0_10px_rgba(255,255,255,0.2)] scale-105 font-bold` 
                    : 'border-transparent hover:bg-dracula-current hover:border-dracula-comment opacity-70 hover:opacity-100'}
            `;

            return (
                <div className="bg-dracula-current p-6 rounded-lg shadow-lg border border-dracula-comment mb-6 overflow-x-auto transition-all duration-300 hover:border-dracula-purple">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 min-w-[500px] gap-4">
                        <h3 className="text-dracula-purple font-bold flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 20V10"></path><path d="M12 20V4"></path><path d="M6 20v-6"></path></svg>
                            Análise de Validade e Estoque
                        </h3>
                        <div className="flex gap-2 text-[10px] md:text-xs flex-wrap">
                            <button onClick={() => onFilterRisk('risk-critical')} className={legendBtnClass('risk-critical', 'dracula-red')}>
                                <span className="w-3 h-3 bg-dracula-red rounded-sm shadow-[0_0_5px_#ff5555]"></span> ≤ 5d
                            </button>
                            <button onClick={() => onFilterRisk('risk-warning')} className={legendBtnClass('risk-warning', 'dracula-orange')}>
                                <span className="w-3 h-3 bg-dracula-orange rounded-sm shadow-[0_0_5px_#ffb86c]"></span> ≤ 15d
                            </button>
                            <button onClick={() => onFilterRisk('risk-attention')} className={legendBtnClass('risk-attention', 'dracula-yellow')}>
                                <span className="w-3 h-3 bg-dracula-yellow rounded-sm shadow-[0_0_5px_#f1fa8c]"></span> ≤ 30d
                            </button>
                            <button onClick={() => onFilterRisk('risk-safe')} className={legendBtnClass('risk-safe', 'dracula-green')}>
                                <span className="w-3 h-3 bg-dracula-green rounded-sm shadow-[0_0_5px_#50fa7b]"></span> Seguro
                            </button>
                        </div>
                    </div>
                    
                    {categoryData.length > 0 ? (
                        <div className="w-full overflow-x-auto">
                            <svg width={width} height={height} className="mx-auto">
                                <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#6272a4" strokeWidth="2" />
                                <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#6272a4" strokeWidth="2" />

                                {categoryData.map((cat, i) => {
                                    const x = padding + gap + (i * (barWidth + gap));
                                    const yBase = height - padding;
                                    
                                    const hSafe = barHeight(cat.safe);
                                    const hAttention = barHeight(cat.attention);
                                    const hWarning = barHeight(cat.warning);
                                    const hCritical = barHeight(cat.critical);
                                    
                                    // Empilhamento
                                    const ySafe = yBase - hSafe;
                                    const yAttention = ySafe - hAttention;
                                    const yWarning = yAttention - hWarning;
                                    const yCritical = yWarning - hCritical;

                                    return (
                                        <g 
                                            key={cat.name} 
                                            className="chart-bar-group cursor-pointer"
                                            onClick={() => onCategoryClick(cat.name)}
                                        >
                                            {/* Safe (Verde) */}
                                            {cat.safe > 0 && <rect x={x} y={ySafe} width={barWidth} height={hSafe} fill="#50fa7b" rx="2" className="opacity-80" />}
                                            
                                            {/* Attention (Amarelo) */}
                                            {cat.attention > 0 && <rect x={x} y={yAttention} width={barWidth} height={hAttention} fill="#f1fa8c" rx="2" className="opacity-90" />}
                                            
                                            {/* Warning (Laranja) */}
                                            {cat.warning > 0 && <rect x={x} y={yWarning} width={barWidth} height={hWarning} fill="#ffb86c" rx="2" className="opacity-95" />}
                                            
                                            {/* Critical (Vermelho) */}
                                            {cat.critical > 0 && <rect x={x} y={yCritical} width={barWidth} height={hCritical} fill="#ff5555" rx="2" />}

                                            {/* Label Valor Total */}
                                            <text x={x + barWidth/2} y={yCritical - 5} textAnchor="middle" fill="#f8f8f2" fontSize="12" fontWeight="bold">
                                                {cat.total}
                                            </text>

                                            {/* Label Categoria */}
                                            <text 
                                                x={x + barWidth/2} y={height - padding + 15} 
                                                textAnchor="middle" fill="#bd93f9" fontSize="11"
                                                className="uppercase font-bold tracking-wider"
                                                style={{textTransform: 'uppercase'}}
                                            >
                                                {cat.name.substring(0, 8)}
                                            </text>
                                            
                                            <title>{`${cat.name}\nTotal: ${cat.total}\nCritico (5d): ${cat.critical}\nAlerta (15d): ${cat.warning}\nAtenção (30d): ${cat.attention}\nSeguro: ${cat.safe}\n\nClique para filtrar!`}</title>
                                        </g>
                                    );
                                })}
                            </svg>
                        </div>
                    ) : (
                        <div className="h-40 flex items-center justify-center text-dracula-comment italic">
                            Nenhum dado para exibir no gráfico com os filtros atuais.
                        </div>
                    )}
                </div>
            );
        };

        // Modal de Adição/Edição
        const Modal = ({ isOpen, onClose, onSave, editingItem }) => {
            const [formData, setFormData] = useState({
                name: '', category: 'Alimento', qty: 0, target: 1, unit: 'unid',
                dateAdded: getTodayDate(), expiryDate: getFutureDate(1)
            });

            useEffect(() => {
                if (editingItem) {
                    setFormData(editingItem);
                } else {
                    setFormData({ 
                        name: '', category: 'Alimento', qty: 0, target: 1, unit: 'unid',
                        dateAdded: getTodayDate(), expiryDate: getFutureDate(1)
                    });
                }
            }, [editingItem, isOpen]);

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({
                    ...formData,
                    id: editingItem ? editingItem.id : Date.now(),
                    qty: Number(formData.qty),
                    target: Number(formData.target)
                });
            };

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-dracula-current p-6 rounded-lg w-full max-w-lg shadow-2xl border border-dracula-purple max-h-[90vh] overflow-y-auto animate-[bounceIn_0.3s_ease-out]">
                        <h2 className="text-2xl font-bold text-dracula-purple mb-4">
                            {editingItem ? 'Editar Item' : 'Novo Recurso'}
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm text-dracula-comment mb-1">Nome do Item</label>
                                <input 
                                    list="item-suggestions"
                                    required
                                    className="w-full bg-dracula-bg border border-dracula-comment rounded p-2 focus:outline-none focus:border-dracula-pink text-dracula-fg placeholder-dracula-comment transition-colors"
                                    placeholder="Ex: Leite em Pó"
                                    value={formData.name}
                                    onChange={e => setFormData({...formData, name: e.target.value})}
                                />
                                <datalist id="item-suggestions">
                                    {PREDEFINED_LIST.map((item, idx) => (
                                        <option key={idx} value={item} />
                                    ))}
                                </datalist>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm text-dracula-comment mb-1">Categoria</label>
                                    <select 
                                        className="w-full bg-dracula-bg border border-dracula-comment rounded p-2 focus:outline-none focus:border-dracula-pink text-dracula-fg transition-colors"
                                        value={formData.category}
                                        onChange={e => setFormData({...formData, category: e.target.value})}
                                    >
                                        <option value="Agua">Água</option>
                                        <option value="Alimento">Alimento</option>
                                        <option value="Saude">Saúde</option>
                                        <option value="Defesa">Defesa</option>
                                        <option value="Energia">Energia</option>
                                        <option value="Outros">Outros</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm text-dracula-comment mb-1">Unidade</label>
                                    <input 
                                        className="w-full bg-dracula-bg border border-dracula-comment rounded p-2 focus:outline-none focus:border-dracula-pink text-dracula-fg transition-colors"
                                        value={formData.unit}
                                        onChange={e => setFormData({...formData, unit: e.target.value})}
                                    />
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm text-dracula-comment mb-1">Qtd Atual</label>
                                    <input 
                                        type="number"
                                        className="w-full bg-dracula-bg border border-dracula-comment rounded p-2 focus:outline-none focus:border-dracula-pink text-dracula-fg transition-colors"
                                        value={formData.qty}
                                        onChange={e => setFormData({...formData, qty: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-dracula-comment mb-1">Meta</label>
                                    <input 
                                        type="number"
                                        className="w-full bg-dracula-bg border border-dracula-comment rounded p-2 focus:outline-none focus:border-dracula-pink text-dracula-fg transition-colors"
                                        value={formData.target}
                                        onChange={e => setFormData({...formData, target: e.target.value})}
                                    />
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4 border-t border-dracula-comment pt-4 mt-2">
                                <div>
                                    <label className="block text-sm text-dracula-comment mb-1">Data Inclusão</label>
                                    <input 
                                        type="date"
                                        className="w-full bg-dracula-bg border border-dracula-comment rounded p-2 focus:outline-none focus:border-dracula-pink text-dracula-fg transition-colors"
                                        value={formData.dateAdded}
                                        onChange={e => setFormData({...formData, dateAdded: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-dracula-comment mb-1 text-dracula-red font-bold">Data Validade</label>
                                    <input 
                                        type="date"
                                        className="w-full bg-dracula-bg border border-dracula-comment rounded p-2 focus:outline-none focus:border-dracula-pink text-dracula-fg transition-colors"
                                        value={formData.expiryDate}
                                        onChange={e => setFormData({...formData, expiryDate: e.target.value})}
                                    />
                                </div>
                            </div>

                            <div className="flex justify-end gap-3 mt-6">
                                <Button type="button" variant="secondary" onClick={onClose}>Cancelar</Button>
                                <Button type="submit" variant="success">Salvar</Button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- 4. APLICATIVO PRINCIPAL ---
        
        function App() {
            const [items, setItems] = useState(() => {
                const saved = localStorage.getItem('survival_stock_v2');
                if (!saved) {
                    const savedOld = localStorage.getItem('survival_stock');
                    if (savedOld) {
                        const oldItems = JSON.parse(savedOld);
                        return oldItems.map(i => ({
                            ...i, 
                            dateAdded: getTodayDate(), 
                            expiryDate: getFutureDate(1)
                        }));
                    }
                    return DEFAULT_ITEMS;
                }
                return JSON.parse(saved);
            });
            const [filter, setFilter] = useState('Todos');
            const [viewMode, setViewMode] = useState('grid');
            const [modalOpen, setModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            
            const [itemToDelete, setItemToDelete] = useState(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                localStorage.setItem('survival_stock_v2', JSON.stringify(items));
            }, [items]);

            const isNearExpiry = (dateStr) => {
                if (!dateStr) return false;
                const today = new Date();
                const expiry = new Date(dateStr);
                const diffTime = expiry - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= 30;
            };

            const isExpired = (dateStr) => {
                 if (!dateStr) return false;
                 return new Date(dateStr) < new Date();
            };

            const filteredItems = useMemo(() => {
                let list = [...items];
                const today = new Date();

                const getDays = (dateStr) => {
                    if (!dateStr) return 9999;
                    const diffTime = new Date(dateStr) - today;
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                };
                
                if (filter === 'Vencendo') {
                    // Mantido para compatibilidade, caso algum outro componente use
                    list = list.filter(i => isNearExpiry(i.expiryDate) || isExpired(i.expiryDate));
                } else if (filter === 'risk-critical') {
                    list = list.filter(i => getDays(i.expiryDate) <= 5);
                } else if (filter === 'risk-warning') {
                    list = list.filter(i => {
                        const d = getDays(i.expiryDate);
                        return d > 5 && d <= 15;
                    });
                } else if (filter === 'risk-attention') {
                    list = list.filter(i => {
                        const d = getDays(i.expiryDate);
                        return d > 15 && d <= 30;
                    });
                } else if (filter === 'risk-safe') {
                    list = list.filter(i => getDays(i.expiryDate) > 30);
                } else if (filter !== 'Todos') {
                    list = list.filter(i => i.category === filter);
                }

                return list.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
            }, [items, filter]);

            const handleDeleteClick = (item) => {
                setItemToDelete(item);
            };

            const confirmDelete = () => {
                if (itemToDelete) {
                    setItems(prev => prev.filter(i => i.id !== itemToDelete.id));
                    setItemToDelete(null);
                }
            };

            const handleAdjustQty = (id, delta) => {
                setItems(prev => prev.map(item => {
                    if (item.id === id) {
                        const newQty = Math.max(0, item.qty + delta);
                        return { ...item, qty: newQty };
                    }
                    return item;
                }));
            };

            const handleSave = (item) => {
                if (items.find(i => i.id === item.id)) {
                    setItems(items.map(i => i.id === item.id ? item : i));
                } else {
                    setItems([...items, item]);
                }
                setModalOpen(false);
                setEditingItem(null);
            };

            const openModal = (item = null) => {
                setEditingItem(item);
                setModalOpen(true);
            };

            const handleExportHTML = () => {
                const sorted = [...items].sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
                const today = new Date().toISOString().split('T')[0];
                
                const htmlContent = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Relatório de Validade - Survivalist</title>
                    <style>
                        body { font-family: 'Segoe UI', sans-serif; background: #282a36; color: #f8f8f2; padding: 40px; }
                        h1 { color: #bd93f9; border-bottom: 2px solid #6272a4; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #6272a4; padding: 12px; text-align: left; }
                        th { background: #44475a; color: #50fa7b; text-transform: uppercase; font-size: 0.9em; }
                        tr:nth-child(even) { background: #2f3240; }
                        tr:hover { background: #44475a; }
                        .danger { color: #ff5555; font-weight: bold; }
                        .warning { color: #ffb86c; }
                    </style>
                </head>
                <body>
                    <h1>Relatório de Estoque & Validade</h1>
                    <p>Gerado em: ${today}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Categoria</th>
                                <th>Quantidade</th>
                                <th>Data Inclusão</th>
                                <th>Validade</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sorted.map(i => {
                                const daysLeft = Math.ceil((new Date(i.expiryDate) - new Date()) / (1000 * 60 * 60 * 24));
                                let statusClass = '';
                                let statusText = 'OK';
                                if (daysLeft < 0) { statusClass = 'danger'; statusText = 'VENCIDO'; }
                                else if (daysLeft < 30) { statusClass = 'danger'; statusText = 'CRÍTICO'; }
                                else if (daysLeft < 90) { statusClass = 'warning'; statusText = 'ATENÇÃO'; }
                                
                                return `
                                    <tr>
                                        <td class="${statusClass}">${i.name}</td>
                                        <td>${i.category}</td>
                                        <td>${i.qty} ${i.unit}</td>
                                        <td>${i.dateAdded}</td>
                                        <td class="${statusClass}">${i.expiryDate.split('-').reverse().join('/')}</td>
                                        <td class="${statusClass}">${statusText} (${daysLeft} dias)</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
                `;

                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Relatorio_Validade_${today}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const handleExportJSON = () => {
                const dataStr = JSON.stringify(items, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `survival_backup_${getTodayDate()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const triggerImport = () => {
                fileInputRef.current.click();
            };

            const handleImportJSON = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const parsed = JSON.parse(event.target.result);
                        if (Array.isArray(parsed)) {
                            if (window.confirm(`ATENÇÃO: Isso substituirá sua lista atual por ${parsed.length} itens do backup. Deseja continuar?`)) {
                                setItems(parsed);
                                alert("Backup restaurado com sucesso!");
                            }
                        }
                    } catch (err) { }
                };
                reader.readAsText(file);
                e.target.value = ''; 
            };

            return (
                <div className="min-h-screen pb-10">
                    <header className="bg-dracula-current border-b border-dracula-comment p-4 sticky top-0 z-40 shadow-xl">
                        <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3 w-full md:w-auto">
                                <span className="text-dracula-purple bg-dracula-bg p-2 rounded-lg">{Icons.shield}</span>
                                <div>
                                    <h1 className="text-xl font-bold text-dracula-fg leading-none">Survivalist</h1>
                                    <p className="text-xs text-dracula-comment">Gerenciador de Estoque</p>
                                </div>
                            </div>
                            <div className="flex flex-wrap gap-2 w-full md:w-auto justify-center md:justify-end">
                                <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={handleImportJSON} />
                                <Button onClick={handleExportHTML} variant="secondary" title="Exportar Relatório HTML">{Icons.fileText} <span className="hidden sm:inline">Relatório</span></Button>
                                <Button onClick={handleExportJSON} variant="secondary" title="Baixar Backup (JSON)">{Icons.download} <span className="hidden sm:inline">Backup</span></Button>
                                <Button onClick={triggerImport} variant="secondary" title="Restaurar Backup (JSON)">{Icons.upload} <span className="hidden sm:inline">Restaurar</span></Button>
                                <Button onClick={() => openModal()} variant="primary" className="ml-2">{Icons.plus} Novo</Button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-4 space-y-8">
                        
                        {/* NOVO GRÁFICO INTERATIVO */}
                        <RiskChart 
                            items={filteredItems} 
                            onCategoryClick={(cat) => setFilter(cat)} 
                            onFilterRisk={(risk) => setFilter(risk)}
                            activeFilter={filter}
                        />

                        {/* Filtros e Toggle */}
                        <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div className="flex overflow-x-auto gap-2 pb-2 scrollbar-hide w-full sm:w-auto">
                                <button
                                    onClick={() => setFilter('Todos')}
                                    className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${
                                        filter === 'Todos' ? 'bg-dracula-purple text-dracula-bg' : 'bg-dracula-current text-dracula-comment hover:bg-dracula-comment hover:text-dracula-fg'
                                    }`}
                                >
                                    Todos
                                </button>
                                {['Agua', 'Alimento', 'Saude', 'Defesa', 'Energia', 'Outros'].map(cat => (
                                    <button
                                        key={cat}
                                        onClick={() => setFilter(cat)}
                                        className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${
                                            filter === cat 
                                            ? 'bg-dracula-pink text-dracula-bg' 
                                            : 'bg-dracula-current text-dracula-comment hover:bg-dracula-comment hover:text-dracula-fg'
                                        }`}
                                    >
                                        {cat}
                                    </button>
                                ))}
                            </div>

                            <div className="flex bg-dracula-current rounded-lg p-1 border border-dracula-comment">
                                <button onClick={() => setViewMode('grid')} className={`p-2 rounded ${viewMode === 'grid' ? 'bg-dracula-purple text-dracula-bg' : 'text-dracula-comment hover:text-dracula-fg'}`}>{Icons.grid}</button>
                                <button onClick={() => setViewMode('list')} className={`p-2 rounded ${viewMode === 'list' ? 'bg-dracula-purple text-dracula-bg' : 'text-dracula-comment hover:text-dracula-fg'}`}>{Icons.list}</button>
                            </div>
                        </div>

                        {/* RENDERIZAÇÃO CONDICIONAL */}
                        {viewMode === 'grid' ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {filteredItems.map((item, index) => {
                                    const nearExpiry = isNearExpiry(item.expiryDate);
                                    const expired = isExpired(item.expiryDate);
                                    return (
                                        <div 
                                            key={item.id} 
                                            style={{ animationDelay: `${index * 50}ms` }}
                                            className={`stagger-item bg-dracula-current rounded-xl p-5 shadow-lg border transition-all duration-300 group relative hover:scale-[1.02] hover:shadow-2xl ${nearExpiry || expired ? 'border-dracula-red' : 'border-transparent hover:border-dracula-purple'}`}
                                        >
                                            {(nearExpiry || expired) && (
                                                <div className="absolute -top-3 right-4 bg-dracula-red text-white text-[10px] font-bold px-2 py-1 rounded-full shadow-md animate-pulse">
                                                    {expired ? 'VENCIDO' : 'VENCE EM BREVE'}
                                                </div>
                                            )}
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-3">
                                                    <div className={`p-2 rounded-lg bg-dracula-bg text-dracula-cyan`}>{Icons[item.icon] || Icons.utensils}</div>
                                                    <div>
                                                        <h3 className="font-bold text-lg leading-tight truncate w-40">{item.name}</h3>
                                                        <span className="text-xs text-dracula-comment uppercase tracking-wider">{item.category}</span>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onClick={() => openModal(item)} className="text-dracula-comment hover:text-dracula-cyan transition-colors" title="Editar">{Icons.edit}</button>
                                                    <button onClick={() => handleDeleteClick(item)} className="text-dracula-comment hover:text-dracula-red transition-colors" title="Excluir">{Icons.trash}</button>
                                                </div>
                                            </div>
                                            <div className="mt-4 space-y-2">
                                                <div className="flex justify-between items-center mb-1">
                                                    <div className="flex items-center gap-3">
                                                        <button onClick={() => handleAdjustQty(item.id, -1)} className="w-8 h-8 rounded-full bg-dracula-bg hover:bg-dracula-red hover:text-white flex items-center justify-center text-dracula-comment transition-colors active:scale-90" title="Remover 1">{Icons.minus}</button>
                                                        <span className="text-2xl font-bold text-dracula-fg text-center min-w-[3rem]">{item.qty} <span className="text-xs font-normal text-dracula-comment block -mt-1">{item.unit}</span></span>
                                                        <button onClick={() => handleAdjustQty(item.id, 1)} className="w-8 h-8 rounded-full bg-dracula-bg hover:bg-dracula-green hover:text-dracula-bg flex items-center justify-center text-dracula-comment transition-colors active:scale-90" title="Adicionar 1">{Icons.plus}</button>
                                                    </div>
                                                    <span className="text-xs text-dracula-comment">Meta: {item.target}</span>
                                                </div>
                                                <ProgressBar current={item.qty} target={item.target} />
                                                <div className="pt-2 mt-2 border-t border-gray-700 flex justify-between items-center text-xs">
                                                    <div className="text-dracula-comment" title="Data de Inclusão">In: {item.dateAdded ? item.dateAdded.split('-').reverse().join('/') : '-'}</div>
                                                    <div className={`font-bold flex items-center gap-1 ${nearExpiry || expired ? 'text-dracula-red' : 'text-dracula-green'}`} title="Validade">{Icons.clock} {item.expiryDate ? item.expiryDate.split('-').reverse().join('/') : '-'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="bg-dracula-current rounded-lg shadow-lg overflow-hidden border border-dracula-comment">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="bg-dracula-bg text-dracula-purple text-sm uppercase">
                                            <th className="p-4 font-bold">Item</th>
                                            <th className="p-4 font-bold hidden sm:table-cell">Categoria</th>
                                            <th className="p-4 font-bold">Estoque</th>
                                            <th className="p-4 font-bold hidden md:table-cell">Validade</th>
                                            <th className="p-4 font-bold text-right">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-dracula-comment">
                                        {filteredItems.map((item, index) => {
                                            const nearExpiry = isNearExpiry(item.expiryDate);
                                            const expired = isExpired(item.expiryDate);
                                            const percent = Math.min(100, Math.round((item.qty / item.target) * 100));
                                            return (
                                                <tr 
                                                    key={item.id} 
                                                    style={{ animationDelay: `${index * 30}ms` }}
                                                    className="stagger-item hover:bg-dracula-bg/50 transition-colors"
                                                >
                                                    <td className="p-4">
                                                        <div className="flex items-center gap-3">
                                                            <div className="text-dracula-cyan">{Icons[item.icon] || Icons.utensils}</div>
                                                            <div>
                                                                <div className="font-bold">{item.name}</div>
                                                                {(nearExpiry || expired) && <span className="text-[10px] text-dracula-red font-bold uppercase">{expired ? 'Vencido' : 'Vence em Breve'}</span>}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td className="p-4 hidden sm:table-cell"><span className="bg-dracula-bg px-2 py-1 rounded text-xs text-dracula-comment">{item.category}</span></td>
                                                    <td className="p-4">
                                                        <div className="flex items-center gap-3">
                                                            <button onClick={() => handleAdjustQty(item.id, -1)} className="w-6 h-6 rounded bg-dracula-bg hover:bg-dracula-red hover:text-white flex items-center justify-center text-dracula-comment transition-colors active:scale-90">{Icons.minus}</button>
                                                            <div className="flex flex-col w-24">
                                                                <div className="text-sm font-bold flex justify-between"><span>{item.qty}</span><span className="text-xs font-normal text-dracula-comment">{item.unit}</span></div>
                                                                <div className="h-1.5 bg-dracula-bg rounded-full overflow-hidden border border-dracula-comment mt-1"><div className={`h-full ${percent < 30 ? 'bg-dracula-red' : percent < 70 ? 'bg-dracula-orange' : 'bg-dracula-green'}`} style={{width: `${percent}%`}}></div></div>
                                                            </div>
                                                            <button onClick={() => handleAdjustQty(item.id, 1)} className="w-6 h-6 rounded bg-dracula-bg hover:bg-dracula-green hover:text-dracula-bg flex items-center justify-center text-dracula-comment transition-colors active:scale-90">{Icons.plus}</button>
                                                        </div>
                                                    </td>
                                                    <td className="p-4 hidden md:table-cell"><div className={`text-sm ${nearExpiry || expired ? 'text-dracula-red font-bold' : 'text-dracula-green'}`}>{item.expiryDate ? item.expiryDate.split('-').reverse().join('/') : '-'}</div></td>
                                                    <td className="p-4 text-right">
                                                        <div className="flex justify-end gap-2">
                                                            <button onClick={() => openModal(item)} className="text-dracula-comment hover:text-dracula-cyan p-1" title="Editar">{Icons.edit}</button>
                                                            <button onClick={() => handleDeleteClick(item)} className="text-dracula-comment hover:text-dracula-red p-1" title="Excluir">{Icons.trash}</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        {filteredItems.length === 0 && (
                            <div className="text-center py-20 text-dracula-comment animate-[fadeInUp_0.5s_ease-out]">
                                <p className="text-xl">Nenhum item encontrado.</p>
                                <button onClick={() => setFilter('Todos')} className="text-dracula-cyan hover:underline mt-2">Limpar filtros</button>
                            </div>
                        )}
                    </main>

                    <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} onSave={handleSave} editingItem={editingItem} />
                    <ConfirmationModal isOpen={!!itemToDelete} onClose={() => setItemToDelete(null)} onConfirm={confirmDelete} title="Excluir Item?" message={`Tem certeza que deseja remover "${itemToDelete?.name}" do seu estoque?`} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>